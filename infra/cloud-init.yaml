#cloud-config
package_update: true
packages:
  - docker.io
  - docker-compose-plugin
  - git

users:
  - default
  - name: azureuser
    groups: [sudo, docker]
    shell: /bin/bash

runcmd:
  # Make sure docker is running and enabled
  - systemctl enable --now docker

  # Clone or update the VLC repo under /opt/vlc
  - [ bash, -lc, 'mkdir -p /opt && cd /opt && if [ ! -d vlc ]; then git clone https://github.com/jurdabos/vlc.git vlc; else cd vlc && git pull; fi' ]

  # Ensure we have a .env file (copy from example if needed; safe if it has no secrets)
  - [ bash, -lc, 'cd /opt/vlc && if [ ! -f .env ] && [ -f .env.example ]; then cp .env.example .env; fi' ]

  # Write systemd unit for the stack
  - |
    cat >/etc/systemd/system/vlc-stack.service <<'EOF'
    [Unit]
    Description=VLC stack (Docker Compose)
    Requires=docker.service network-online.target
    After=docker.service network-online.target

    [Service]
    Type=oneshot
    WorkingDirectory=/opt/vlc
    ExecStartPre=/usr/bin/docker compose --env-file .env -f compose/docker-compose.yml pull
    ExecStart=/usr/bin/docker compose --env-file .env -f compose/docker-compose.yml up -d --remove-orphans
    ExecStop=/usr/bin/docker compose --env-file .env -f compose/docker-compose.yml down
    RemainAfterExit=yes
    Restart=on-failure
    RestartSec=5s
    TimeoutStartSec=0

    [Install]
    WantedBy=multi-user.target
    EOF

  - systemctl daemon-reload
  - systemctl enable --now vlc-stack

  # 1-time DB/Kafka bootstrap, idempotent by design
  - [ bash, -lc, 'cd /opt/vlc && chmod +x scripts/set_vlc_db_password.sh scripts/bootstrap_kafka.sh' ]
  - [ bash, -lc, 'cd /opt/vlc && ./scripts/set_vlc_db_password.sh || true' ]
  - [ bash, -lc, 'cd /opt/vlc && ./scripts/bootstrap_kafka.sh || true' ]
